# Fail2ban configuration for AdGuard Home infrastructure
# Enhanced protection against brute force attacks and abuse

[DEFAULT]
# Override default settings for AdGuard infrastructure
bantime = 3600
findtime = 600
maxretry = 5
banaction = ufw
backend = auto
usedns = warn
logencoding = auto
enabled = false

# Email notification settings
destemail = ${ADMIN_EMAIL}
sender = ${ADMIN_EMAIL}
mta = sendmail
action = %(action_mwl)s

[sshd-adguard]
# Enhanced SSH protection for custom port
enabled = true
port = ${SSH_PORT:-2222}
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 7200
findtime = 600
action = %(action_mwl)s
         ufw[port="%(port)s",protocol="tcp"]

[sshd-ddos]
# Protection against SSH DoS attacks
enabled = true
port = ${SSH_PORT:-2222}
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 86400
findtime = 300

[adguard-auth]
# AdGuard Home authentication protection
enabled = true
port = ${ADGUARD_WEB_PORT:-3000}
filter = adguard-auth
logpath = /opt/adguard/logs/adguard.log
maxretry = 5
bantime = 3600
findtime = 600
action = ufw[port="%(port)s",protocol="tcp"]

[adguard-dos]
# AdGuard Home DoS protection
enabled = true
port = 53
filter = adguard-dos
logpath = /opt/adguard/logs/adguard.log
maxretry = 100
bantime = 1800
findtime = 60
protocol = udp
action = ufw[port="53",protocol="udp"]
         ufw[port="53",protocol="tcp"]

[grafana-auth]
# Grafana authentication protection
enabled = true
port = ${GRAFANA_PORT:-3001}
filter = grafana-auth
logpath = /opt/monitoring/grafana/data/log/grafana.log
maxretry = 5
bantime = 3600
findtime = 600
action = ufw[port="%(port)s",protocol="tcp"]

[prometheus-abuse]
# Prometheus endpoint abuse protection
enabled = true
port = ${PROMETHEUS_PORT:-9090}
filter = prometheus-abuse
logpath = /var/log/nginx/access.log
maxretry = 50
bantime = 1800
findtime = 300
action = ufw[port="%(port)s",protocol="tcp"]

[http-get-dos]
# Generic HTTP GET DoS protection
enabled = true
port = http,https,${ADGUARD_WEB_PORT:-3000},${GRAFANA_PORT:-3001}
filter = http-get-dos
logpath = /var/log/nginx/access.log
maxretry = 300
findtime = 300
bantime = 600
action = ufw[port="http,https",protocol="tcp"]

[recidive]
# Repeat offender protection (bans IPs that get banned multiple times)
enabled = true
filter = recidive
logpath = /var/log/fail2ban.log
action = ufw[port="all"]
bantime = 604800  # 1 week
findtime = 86400  # 1 day
maxretry = 3

[dns-amplification]
# DNS amplification attack protection
enabled = true
port = 53
filter = dns-amplification
logpath = /opt/adguard/logs/adguard.log
maxretry = 10
bantime = 3600
findtime = 60
protocol = udp
action = ufw[port="53",protocol="udp"]

[docker-abuse]
# Docker API abuse protection (if exposed)
enabled = false  # Enable only if Docker API is exposed
port = 2376
filter = docker-abuse
logpath = /var/log/docker.log
maxretry = 3
bantime = 86400
findtime = 600

[monitoring-abuse]
# Monitoring endpoints abuse protection
enabled = true
port = ${PROMETHEUS_PORT:-9090},${GRAFANA_PORT:-3001},9093,9100
filter = monitoring-abuse
logpath = /var/log/nginx/access.log
maxretry = 100
bantime = 1800
findtime = 300
action = ufw[port="%(port)s",protocol="tcp"]

# Australian-specific protection
[au-government-impersonation]
# Protection against Australian government impersonation attacks
enabled = true
filter = au-gov-impersonation
logpath = /var/log/nginx/access.log
         /opt/adguard/logs/adguard.log
maxretry = 1
bantime = 86400
findtime = 3600
action = ufw[port="all"]

[malware-callback]
# Protection against malware callback attempts
enabled = true
filter = malware-callback
logpath = /opt/adguard/logs/adguard.log
maxretry = 5
bantime = 86400
findtime = 3600
action = ufw[port="all"]

[cryptocurrency-mining]
# Protection against cryptocurrency mining attempts
enabled = true
filter = crypto-mining
logpath = /opt/adguard/logs/adguard.log
maxretry = 10
bantime = 86400
findtime = 3600
action = ufw[port="all"]

# Geographic-based protection
[non-au-ssh]
# Enhanced protection for SSH from non-Australian IPs (optional)
enabled = false  # Enable if you want geo-blocking
port = ${SSH_PORT:-2222}
filter = sshd
logpath = /var/log/auth.log
maxretry = 1
bantime = 86400
findtime = 86400
action = ufw[port="%(port)s",protocol="tcp"]

# Custom filters for specific attack patterns
[adguard-config-access]
# Protection against unauthorized config access attempts
enabled = true
filter = adguard-config
logpath = /opt/adguard/logs/adguard.log
maxretry = 3
bantime = 7200
findtime = 600
action = ufw[port="all"]

[docker-escape-attempt]
# Protection against container escape attempts
enabled = true
filter = docker-escape
logpath = /var/log/syslog
         /var/log/kern.log
maxretry = 1
bantime = 86400
findtime = 3600
action = ufw[port="all"]

[privilege-escalation]
# Protection against privilege escalation attempts
enabled = true
filter = privilege-escalation
logpath = /var/log/auth.log
         /var/log/syslog
maxretry = 1
bantime = 86400
findtime = 3600
action = ufw[port="all"]